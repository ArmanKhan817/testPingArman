- hosts: all
  gather_facts: yes

  vars:
    ansible_become_user: "{{ username }}"
    ansible_become_pass: "{{ password }}"

  tasks:

    ###########################################################################
    # Update EnablePlusSubscription in configureDymocksLoyalty.ps1
    ###########################################################################
    - name: Check and update EnablePlusSubscription in configureDymocksLoyalty.ps1
      win_shell: |
        $filePath = "C:\ARFILES\DymocksLoyaltyUpgrade\configureDymocksLoyalty.ps1"

        if (Test-Path $filePath) {
          $content = Get-Content $filePath
          $modified = $false

          if ($content -match '\$EnablePlusSubscription\s*=\s*"false"') {
            $content = $content -replace '(\$EnablePlusSubscription\s*=\s*)"false"', '$1"true"'
            $modified = $true
          }

          if ($modified) {
            Set-Content -Path $filePath -Value $content
            Write-Output "✅ Updated EnablePlusSubscription to true."
          } else {
            Write-Output "ℹ️ No change needed for EnablePlusSubscription."
          }
        } else {
          Write-Output "❌ File not found: $filePath"
        }
      register: update_ps1_result
      ignore_errors: yes
      changed_when: "'Updated EnablePlusSubscription to true.' in update_ps1_result.stdout"

    - name: Output result for configureDymocksLoyalty.ps1
      ansible.builtin.debug:
        var: update_ps1_result.stdout

    ###########################################################################
    # Update StorePluginConfig.sql values
    ###########################################################################
    - name: Check and update StorePluginConfig.sql values
      win_shell: |
        $filePath = "C:\ARFILES\DymocksLoyaltyUpgrade\Scripts\Loyalty\StorePluginConfig.sql"
        $changes = @()

        if (Test-Path $filePath) {
          $content = Get-Content $filePath
          $modified = $false

          if ($content -match '<EnableDonation>\s*false\s*</EnableDonation>') {
            $content = $content -replace '<EnableDonation>\s*false\s*</EnableDonation>', '<EnableDonation>true</EnableDonation>'
            $changes += "✔️ Changed <EnableDonation> to true"
            $modified = $true
          }

          if ($content -match '<DefaultDonation>\s*2\s*</DefaultDonation>') {
            $content = $content -replace '<DefaultDonation>\s*2\s*</DefaultDonation>', '<DefaultDonation>1</DefaultDonation>'
            $changes += "✔️ Changed <DefaultDonation> from 2 to 1"
            $modified = $true
          }

          if ($modified) {
            Set-Content -Path $filePath -Value $content
            $changes += "✅ StorePluginConfig.sql updated successfully."
          } else {
            $changes += "ℹ️ No changes needed in StorePluginConfig.sql."
          }
        } else {
          $changes += "❌ StorePluginConfig.sql not found."
        }

        $changes -join "`r`n"
      register: update_sql_result
      ignore_errors: yes
      changed_when: "'updated successfully' in update_sql_result.stdout"

    - name: Output result for StorePluginConfig.sql
      ansible.builtin.debug:
        var: update_sql_result.stdout

    ###########################################################################
    # Add -TrustServerCertificate to Invoke-Sqlcmd
    ###########################################################################
    - name: Add -TrustServerCertificate to Invoke-Sqlcmd in configureDymocksLoyalty.ps1
      win_shell: |
        $filePath = "C:\ARFILES\DymocksLoyaltyUpgrade\configureDymocksLoyalty.ps1"

        if (Test-Path $filePath) {
          $content = Get-Content $filePath -Raw
          $modified = $false

          if ($content -match 'Invoke-Sqlcmd\s+[^\r\n]*-ErrorAction\s+Stop' -and
              $content -notmatch '-TrustServerCertificate') {

            $content = $content -replace `
              '(Invoke-Sqlcmd\s+[^\r\n]*-ErrorAction\s+Stop)',
              '$1 -TrustServerCertificate'

            $modified = $true
          }

          if ($modified) {
            Set-Content -Path $filePath -Value $content
            Write-Output "✅ Added -TrustServerCertificate to Invoke-Sqlcmd."
          } else {
            Write-Output "ℹ️ No change needed (already present or Invoke-Sqlcmd not found)."
          }
        } else {
          Write-Output "❌ File not found: $filePath"
        }
      register: trust_cert_update_result
      ignore_errors: yes
      changed_when: "'Added -TrustServerCertificate' in trust_cert_update_result.stdout"

    - name: Output result for TrustServerCertificate update
      ansible.builtin.debug:
        var: trust_cert_update_result.stdout

  become: yes
  become_method: runas
  become_flags: logon_type=new_credentials logon_flags=netcredentials_only
