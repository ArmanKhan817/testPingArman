---
- name: Run deleteS3content.py with virtualenv and AWX credentials
  hosts: all
  gather_facts: no

  tasks:
    - name: Ensure script directory exists
      win_file:
        path: C:\trade_report_UA_backup\tradeReportAppflowAutomation
        state: directory

    - name: Run deleteS3content.py in virtual environment
      win_command: >
        cmd /c "C:\trade_report_UA_backup\venv\Scripts\activate && python C:\trade_report_UA_backup\tradeReportAppflowAutomation\deleteS3content.py"
      environment:
        AWS_ACCESS_KEY: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
        AWS_SECRET_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
      register: py_output
      ignore_errors: yes

    - name: Show script stdout
      debug:
        var: py_output.stdout_lines

    - name: Show script stderr
      debug:
        var: py_output.stderr_lines
